var cvpHandlers={canvasClickHandler:null,videoTimeUpdateHandler:null,videoCanPlayHandler:null,windowResizeHandler:null},CanvasVideoPlayer=function(e){var i;for(i in this.options={framesPerSecond:25,hideVideo:!0,autoplay:!1,audio:!1,timelineSelector:!1,resetOnLastFrame:!0,loop:!1},e)this.options[i]=e[i];if(this.video=document.querySelector(this.options.videoSelector),this.canvas=document.querySelector(this.options.canvasSelector),this.timeline=document.querySelector(this.options.timelineSelector),this.timelinePassed=document.querySelector(this.options.timelineSelector+"> div"),this.options.videoSelector&&this.video)if(this.options.canvasSelector&&this.canvas)if(!this.options.timelineSelector||this.timeline)if(!this.options.timelineSelector||this.timelinePassed){if(this.options.audio){if("string"==typeof this.options.audio){if(this.audio=document.querySelectorAll(this.options.audio)[0],!this.audio)return void console.error('Element for the "audio" not found')}else this.audio=document.createElement("audio"),this.audio.innerHTML=this.video.innerHTML,this.video.parentNode.insertBefore(this.audio,this.video),this.audio.load();/iPad|iPhone|iPod/.test(navigator.platform)&&(this.options.autoplay=!1)}this.ctx=this.canvas.getContext("2d"),this.playing=!1,this.resizeTimeoutReference=!1,this.RESIZE_TIMEOUT=1e3,this.init(),this.bind()}else console.error('Element for the "timelinePassed" not found');else console.error('Element for the "timelineSelector" selector not found');else console.error('No "canvasSelector" property, or the element is not found');else console.error('No "videoSelector" property, or the element is not found')};CanvasVideoPlayer.prototype.init=function(){this.video.load(),this.setCanvasSize(),this.options.hideVideo&&(this.video.style.display="none")},CanvasVideoPlayer.prototype.getOffset=function(e){var i,t;if(e)return(t=e.getBoundingClientRect()).width||t.height||e.getClientRects().length?(i=e.ownerDocument.documentElement,{top:t.top+window.pageYOffset-i.clientTop,left:t.left+window.pageXOffset-i.clientLeft}):void 0},CanvasVideoPlayer.prototype.jumpTo=function(e){this.video.currentTime=this.video.duration*e,this.options.audio&&(this.audio.currentTime=this.audio.duration*e)},CanvasVideoPlayer.prototype.bind=function(){var e=this;this.canvas.addEventListener("click",cvpHandlers.canvasClickHandler=function(){e.playPause()}),this.video.addEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler=function(){e.drawFrame(),e.options.timelineSelector&&e.updateTimeline()}),this.video.addEventListener("canplay",cvpHandlers.videoCanPlayHandler=function(){e.drawFrame()}),this.video.readyState>=2&&e.drawFrame(),e.options.autoplay&&e.play(),e.options.timelineSelector&&this.timeline.addEventListener("click",function(i){var t=(i.clientX-e.getOffset(e.canvas).left)/e.timeline.offsetWidth;e.jumpTo(t)}),window.addEventListener("resize",cvpHandlers.windowResizeHandler=function(){clearTimeout(e.resizeTimeoutReference),e.resizeTimeoutReference=setTimeout(function(){e.setCanvasSize(),e.drawFrame()},e.RESIZE_TIMEOUT)}),this.unbind=function(){this.canvas.removeEventListener("click",cvpHandlers.canvasClickHandler),this.video.removeEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler),this.video.removeEventListener("canplay",cvpHandlers.videoCanPlayHandler),window.removeEventListener("resize",cvpHandlers.windowResizeHandler),this.options.audio&&this.audio.parentNode.removeChild(this.audio)}},CanvasVideoPlayer.prototype.updateTimeline=function(){var e=(100*this.video.currentTime/this.video.duration).toFixed(2);this.timelinePassed.style.width=e+"%"},CanvasVideoPlayer.prototype.setCanvasSize=function(){this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height)},CanvasVideoPlayer.prototype.play=function(){this.lastTime=Date.now(),this.playing=!0,this.loop(),this.options.audio&&(this.audio.currentTime=this.video.currentTime,this.audio.play())},CanvasVideoPlayer.prototype.pause=function(){this.playing=!1,this.options.audio&&this.audio.pause()},CanvasVideoPlayer.prototype.playPause=function(){this.playing?this.pause():this.play()},CanvasVideoPlayer.prototype.loop=function(){var e=this,i=Date.now(),t=(i-this.lastTime)/1e3;t>=1/this.options.framesPerSecond&&(this.video.currentTime=this.video.currentTime+t,this.lastTime=i,this.audio&&Math.abs(this.audio.currentTime-this.video.currentTime)>.3&&(this.audio.currentTime=this.video.currentTime)),this.video.currentTime>=this.video.duration&&(this.playing=!1,!0===this.options.resetOnLastFrame&&(this.video.currentTime=0),!0===this.options.loop&&(this.video.currentTime=0,this.play())),this.playing?this.animationFrame=requestAnimationFrame(function(){e.loop()}):cancelAnimationFrame(this.animationFrame)},CanvasVideoPlayer.prototype.drawFrame=function(){this.ctx.drawImage(this.video,0,0,this.width,this.height)};